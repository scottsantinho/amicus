{% extends 'nucleus/base.html' %}
{% load static %}

{% block title %}Your Conversations{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100">
    <!-- Sidebar -->
    <div class="w-1/3 bg-white p-6 overflow-y-auto">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Your Conversations</h2>
        <ul id="conversation-list">
            {% for conv in conversations %}
                <li class="mb-2 flex justify-between items-center">
                    <a href="#" class="load-conversation block p-3 bg-gray-200 hover:bg-gray-300 rounded-lg transition duration-300 flex-grow mr-2" data-conversation-id="{{ conv.pk }}">
                        Conversation {{ conv.pk }}
                    </a>
                    <button class="delete-conversation text-red-500 hover:text-red-700" data-conversation-id="{{ conv.pk }}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </li>
            {% empty %}
                <li id="no-conversations">No conversations yet.</li>
            {% endfor %}
        </ul>
        <button id="new-conversation-btn" class="mt-4 inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300">
            New Conversation
        </button>
    </div>

    <!-- Chat Window -->
    <div id="chat-window" class="w-2/3 flex flex-col bg-white shadow-lg">
        <div class="p-4 border-b border-gray-200">
            <h2 id="conversation-title" class="text-xl font-semibold text-gray-800">{% if conversation %}Conversation {{ conversation.pk }}{% else %}No Conversation Selected{% endif %}</h2>
        </div>
        <div id="conversation-content" class="flex-grow overflow-y-auto">
            {% if conversation %}
                {% include "colloquium/conversation_detail.html" with conversation=conversation form=form %}
            {% else %}
                <div class="flex-grow flex items-center justify-center bg-gray-50">
                    <p class="text-2xl text-gray-400 font-light">Select a conversation or start a new one.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="{% static 'js/chat.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectedConversationId = localStorage.getItem('selectedConversationId');
    if (selectedConversationId) {
        loadConversation(selectedConversationId);
    }

    document.getElementById('new-conversation-btn').addEventListener('click', createNewConversation);

    document.querySelectorAll('.load-conversation').forEach(function(element) {
        element.addEventListener('click', function(e) {
            e.preventDefault();
            var conversationId = this.getAttribute('data-conversation-id');
            loadConversation(conversationId);
        });
    });

    // Add event listeners for delete buttons
    document.querySelectorAll('.delete-conversation').forEach(function(element) {
        element.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Are you sure you want to delete this conversation?')) {
                deleteConversation(this.getAttribute('data-conversation-id'));
            }
        });
    });
});

function createNewConversation() {
    fetch('{% url 'new_conversation' %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const noConversationsElem = document.getElementById('no-conversations');
            if (noConversationsElem) {
                noConversationsElem.remove();
            }

            const conversationList = document.getElementById('conversation-list');
            const newConversationItem = document.createElement('li');
            newConversationItem.className = 'mb-2 flex justify-between items-center';
            newConversationItem.innerHTML = `
                <a href="#" class="load-conversation block p-3 bg-gray-200 hover:bg-gray-300 rounded-lg transition duration-300 flex-grow mr-2" data-conversation-id="${data.conversation_id}">
                    Conversation ${data.conversation_id}
                </a>
                <button class="delete-conversation text-red-500 hover:text-red-700" data-conversation-id="${data.conversation_id}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            conversationList.insertBefore(newConversationItem, conversationList.firstChild);

            newConversationItem.querySelector('.load-conversation').addEventListener('click', function(e) {
                e.preventDefault();
                loadConversation(data.conversation_id);
            });

            newConversationItem.querySelector('.delete-conversation').addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Are you sure you want to delete this conversation?')) {
                    deleteConversation(data.conversation_id);
                }
            });

            loadConversation(data.conversation_id);
        } else {
            console.error('Failed to create new conversation');
        }
    })
    .catch(error => console.error('Error:', error));
}

function deleteConversation(conversationId) {
    fetch(`/conversations/${conversationId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the conversation from the list
            const conversationElement = document.querySelector(`.load-conversation[data-conversation-id="${conversationId}"]`);
            if (conversationElement) {
                conversationElement.closest('li').remove();
            }

            // Check if it was the last conversation
            const conversationList = document.getElementById('conversation-list');
            if (conversationList.children.length === 0) {
                // Add the "No conversations yet" message
                const noConversationsElem = document.createElement('li');
                noConversationsElem.id = 'no-conversations';
                noConversationsElem.textContent = 'No conversations yet.';
                conversationList.appendChild(noConversationsElem);

                // Clear the chat window
                document.getElementById('conversation-content').innerHTML = `
                    <div class="flex-grow flex items-center justify-center bg-gray-50">
                        <p class="text-2xl text-gray-400 font-light">Please start a new conversation or select an existing one.</p>
                    </div>
                `;
                document.getElementById('conversation-title').textContent = 'No Conversation Selected';
            } else if (conversationId === localStorage.getItem('selectedConversationId')) {
                // If the deleted conversation was the selected one, load the first available conversation
                const firstConversation = document.querySelector('.load-conversation');
                if (firstConversation) {
                    loadConversation(firstConversation.getAttribute('data-conversation-id'));
                }
            }

            // Clear the selected conversation from localStorage if it was deleted
            if (conversationId === localStorage.getItem('selectedConversationId')) {
                localStorage.removeItem('selectedConversationId');
            }
        } else {
            console.error('Failed to delete conversation');
        }
    })
    .catch(error => console.error('Error:', error));
}

function loadConversation(conversationId) {
    fetch(`/conversations/${conversationId}/`)
    .then(response => response.text())
    .then(html => {
        document.getElementById('conversation-content').innerHTML = html;
        document.getElementById('conversation-title').textContent = `Conversation ${conversationId}`;
        
        document.querySelectorAll('.load-conversation').forEach(el => {
            el.classList.remove('bg-blue-200');
            el.classList.add('bg-gray-200');
        });
        const activeConversation = document.querySelector(`.load-conversation[data-conversation-id="${conversationId}"]`);
        if (activeConversation) {
            activeConversation.classList.remove('bg-gray-200');
            activeConversation.classList.add('bg-blue-200');
        }

        localStorage.setItem('selectedConversationId', conversationId);

        const messageForm = document.querySelector('#message-form');
        if (messageForm) {
            messageForm.dataset.conversationId = conversationId;
        }

        initializeChat();
    })
    .catch(error => console.error('Error:', error));
}
</script>
{% endblock %}

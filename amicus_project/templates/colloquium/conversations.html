{% extends 'nucleus/base.html' %}

{% block title %}Conversations{% endblock %}

{% block content %}
<div class="flex h-full">
    <!-- Conversation list -->
    <div class="w-1/3 border-r overflow-y-auto">
        <h2 class="text-lg font-semibold p-4">Your Conversations</h2>
        <ul>
            {% for conv in conversations %}
                <li class="p-2 {% if conv == conversation %}bg-gray-200{% endif %}">
                    <a href="?conversation_id={{ conv.pk }}" class="text-blue-500 hover:underline">
                        Conversation {{ conv.pk }}
                    </a>
                </li>
            {% empty %}
                <li class="p-2">No conversations yet.</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Conversation detail -->
    <div class="w-2/3 flex flex-col h-full">
        {% if conversation %}
            <div class="p-4 border-b bg-white">
                <h1 class="text-xl font-semibold text-gray-800">Conversation {{ conversation.pk }}</h1>
            </div>
            
            <div id="messages" class="flex-grow overflow-y-auto p-4 space-y-4">
                {% include 'colloquium/message_list.html' with messages=conversation.messages.all %}
            </div>
            
            <form id="message-form" action="{% url 'new_message' conversation.pk %}" method="post"
                  hx-post="{% url 'new_message' conversation.pk %}" 
                  hx-target="#messages" 
                  hx-swap="beforeend"
                  class="p-4 border-t bg-white">
                {% csrf_token %}
                <div class="flex items-center">
                    {{ form.content }}
                    <button type="submit" class="ml-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Send
                    </button>
                </div>
            </form>
        {% else %}
            <div class="flex items-center justify-center h-full">
                <p class="text-gray-500">Select a conversation to view messages</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
    // Scroll to bottom of messages
    function scrollToBottom() {
        var messagesDiv = document.getElementById('messages');
        if (messagesDiv) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }
    scrollToBottom();

    // Set up a MutationObserver to watch for changes in the messages div
    var messagesDiv = document.getElementById('messages');
    if (messagesDiv) {
        var observer = new MutationObserver(scrollToBottom);
        observer.observe(messagesDiv, { childList: true });
    }

    // Handle Enter key press
    var messageForm = document.getElementById('message-form');
    if (messageForm) {
        messageForm.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.submit();
            }
        });
    }
</script>
{% endblock %}

<div class="flex flex-col h-full bg-gray-100">
    <!-- Message List -->
    <div id="message-list" class="flex-grow overflow-y-auto p-4 space-y-4">
        {% for message in messages %}
            <div class="flex {% if message.is_user %}justify-end{% else %}justify-start{% endif %} mb-4">
                <div class="max-w-xs lg:max-w-md">
                    <div class="text-sm font-semibold mb-1 {% if message.is_user %}text-right text-blue-600{% else %}text-left text-gray-600{% endif %}">
                        {% if message.is_user %}{{ user_name }}{% else %}{{ ai_name }}{% endif %}
                    </div>
                    <div class="p-3 rounded-lg {% if message.is_user %}bg-blue-500 text-white{% else %}bg-gray-200{% endif %}">
                        <div class="text-sm">{{ message.content }}</div>
                        <div class="text-xs mt-1 {% if message.is_user %}text-blue-200{% else %}text-gray-500{% endif %}">
                            {{ message.timestamp|date:"F d, Y H:i" }}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <!-- Message Form -->
    <div class="bg-white border-t p-4">
        <form id="message-form" class="flex items-center space-x-2" data-conversation-id="{{ conversation.pk }}">
            {% csrf_token %}
            <textarea name="content" class="flex-grow p-2 border rounded-lg" placeholder="Type your message..." rows="1"></textarea>
            <button type="submit" class="bg-blue-500 text-white p-2 rounded-full">
                <!-- Send Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </button>
        </form>
    </div>
    
    <!-- Hidden elements for user and AI names -->
    <span id="current-user-name" style="display: none;">
        {{ request.user.profile.user_name|default:request.user.username }}
    </span>
    <span id="ai-name" style="display: none;">
        {{ ai_name }}
    </span>
</div>

<!-- JavaScript for Handling Message Submission -->
<script>
    const messageList = document.getElementById('message-list');
    const messageForm = document.getElementById('message-form');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const conversationId = "{{ conversation.pk }}";

    // Store the conversation ID in localStorage
    localStorage.setItem('selectedConversationId', conversationId);

    function createMessageElement(name, content, isUser, timestamp) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`;
        messageDiv.innerHTML = `
            <div class="max-w-xs lg:max-w-md">
                <div class="text-sm font-semibold mb-1 ${isUser ? 'text-right text-blue-600' : 'text-left text-gray-600'}">
                    ${name}
                </div>
                <div class="p-3 rounded-lg ${isUser ? 'bg-blue-500 text-white' : 'bg-gray-200'}">
                    <div class="text-sm">${content}</div>
                    <div class="text-xs mt-1 ${isUser ? 'text-blue-200' : 'text-gray-500'}">
                        ${timestamp}
                    </div>
                </div>
            </div>
        `;
        return messageDiv;
    }

    function appendMessage(message, isUser) {
        const messageDiv = createMessageElement(message.name, message.content, isUser, message.timestamp);
        messageList.appendChild(messageDiv);
        scrollToBottom();
    }

    function scrollToBottom() {
        messageList.scrollTop = messageList.scrollHeight;
    }

    messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(messageForm);
        const content = formData.get('content');

        if (content.trim()) {
            try {
                const response = await fetch(`/conversations/${conversationId}/new_message/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: content }),
                });

                if (response.ok) {
                    const data = await response.json();
                    appendMessage(data.user_message, true);
                    appendMessage(data.ai_message, false);
                    messageForm.reset();
                } else {
                    console.error('Failed to send message:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
    });

    // Scroll to bottom when the page loads
    window.addEventListener('load', scrollToBottom);
</script>

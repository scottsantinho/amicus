<div class="flex flex-col h-full bg-gray-100">
    <!-- Message List -->
    <div id="message-list" class="flex-grow overflow-y-auto p-4 space-y-4">
        {% for message in conversation.messages.all %}
            {% include 'colloquium/message.html' with message=message %}
        {% endfor %}
    </div>
    
    <!-- Message Form -->
    <div class="bg-white border-t p-4">
        <form id="message-form" class="flex items-center space-x-2">
            {% csrf_token %}
            <textarea name="content" class="flex-grow p-2 border rounded-lg" placeholder="Type your message..." rows="1"></textarea>
            <button type="submit" class="bg-blue-500 text-white p-2 rounded-full">
                <!-- Send Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </button>
        </form>
    </div>
    
    <!-- JavaScript for Handling Message Submission -->
    <script>
        const messageList = document.getElementById('message-list');
        const messageForm = document.getElementById('message-form');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        function createMessageElement(name, content, isUser, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`;
            
            const containerDiv = document.createElement('div');
            containerDiv.className = 'max-w-xs lg:max-w-md';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = `text-sm font-semibold mb-1 ${isUser ? 'text-right text-blue-600' : 'text-left text-gray-600'}`;
            nameDiv.textContent = name;
            
            const innerDiv = document.createElement('div');
            innerDiv.className = `p-3 rounded-lg ${isUser ? 'bg-blue-500 text-white' : 'bg-gray-200'}`;
            
            const textDiv = document.createElement('div');
            textDiv.className = 'text-sm';
            textDiv.textContent = content;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = `text-xs mt-1 ${isUser ? 'text-blue-200' : 'text-gray-500'}`;
            timeDiv.textContent = timestamp;
            
            innerDiv.appendChild(textDiv);
            innerDiv.appendChild(timeDiv);
            containerDiv.appendChild(nameDiv);
            containerDiv.appendChild(innerDiv);
            messageDiv.appendChild(containerDiv);
            return messageDiv;
        }

        // Function to append a message to the message list
        function appendMessage(message, isUser) {
            const messageDiv = createMessageElement(message.name, message.content, isUser, message.timestamp);
            messageList.appendChild(messageDiv);
            scrollToBottom();
        }

        // Function to scroll to the bottom of the message list
        function scrollToBottom() {
            messageList.scrollTop = messageList.scrollHeight;
        }

        // Handle form submission for sending messages
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(messageForm);
            const content = formData.get('content');

            if (content.trim()) {
                const conversationId = "{{ conversation.pk }}";  // Ensure this is available

                try {
                    const response = await fetch(`/conversations/${conversationId}/new_message/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ content: content }),
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // Append user message
                        appendMessage(data.user_message, true);
                        // Append AI message
                        appendMessage(data.ai_message, false);
                        // Reset the form
                        messageForm.reset();
                    } else {
                        console.error('Failed to send message:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        });

        // Scroll to the bottom when the page loads
        window.addEventListener('load', () => {
            scrollToBottom();
        });
    </script>
</div>
